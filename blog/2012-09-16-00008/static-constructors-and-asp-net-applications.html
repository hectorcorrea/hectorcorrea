<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="HectorCorrea.com">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>HectorCorrea.com</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <link rel="canonical" href="https://hectorcorrea.com" />

    <style>
      .header-container {
        background-color:  #e1ebf7;
        margin-left: 0px;
        max-width: unset;
        border-bottom-style: solid;
        border-bottom-width: 2px;
        max-height: 75px;
      }

      h1 {
        margin-top: 20px;
      }

      blockquote {
        padding: 10px 20px;
        margin: 0 0 20px;
        border-left: 5px solid #eee;
        font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;
      }

      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      /* Overwrite Bootstrap's default */
      code {
        background-color: #f0f1f2;
        color: #0D0D0D; /* gray-ish */
      }

      /* Custom code and terminal styles */
      pre, pre.code {
        margin-left: 20px;
        display: block;
        padding: 9.5px;
        margin: 0 0 10px;
        margin-left: 0px;
        font-size: 13px;
        line-height: 1.428571429;
        color: #333;
        word-break: break-all;
        word-wrap: break-word;
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      pre.terminal {
        margin-left: 20px;
        margin-bottom: 20px;
        background-color: #363446;
        color: #DAD681; /* yellow-ish */
        padding-bottom: 10px;
        padding-top: 10px;
        padding-left: 10px;
        padding-right: 50px;
      }

      .socialList {
        list-style: none;
        padding: 5px;
      }

      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }

      footer {
        font-weight: lighter;
      }
    </style>
  </head>
  <body>

    <div class="container header-container">
      <!-- header source: https://getbootstrap.com/docs/5.1/examples/headers/
        changes: removed border-bottom -->
      <header class="d-flex flex-wrap justify-content-center py-3 mb-4">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
          <span class="fs-4">HectorCorrea.com</span>
        </a>
        <ul class="nav nav-pills">
          <li class="nav-item"><a id="home-menu" href="/" class="nav-link" aria-current="page">Home</a></li>
          <li class="nav-item"><a id="about-menu" href="/about" class="nav-link">About</a></li>
          <li class="nav-item"><a id="blog-menu" href="/blog" class="nav-link">Blog</a></li>
        </ul>
      </header>
    </div>

    <div class="container">
      <h1>Static constructors and ASP.NET applications</h1>
<p>A few days ago I was running into an issue with a static class in an ASP.NET application. The issue (I thought) was that the static constructor was not being fired. It turns out the static constructor was being fired as it should but not as often as I thought it would be.</p>

<p>Static constructs are fired once per App Domain.</p>

<p>In a <i>Windows application</i> this means that the constructor is fired once every time I launch the application and access the static class. If I close the application, run it again, and hit the static class the constructor will be fired again.</p>

<p>In a <i>Web application</i> that is also the case, but that does not translate to every time I close and re-open the browser. Closing the browser and re-launching it does not terminate the application and re-launches it.</p>

<p>Here is a simplified example of the scenario that I ran into, notice the <code>_count = 0</code> in the constructor:</p>

<pre class="code">
public static class StaticClass 
{ 
    static int _count; 
    static StaticClass() 
    { 
        _count = 0; 
    } 
    public static int Count 
    { 
        get 
        { 
            _count++; 
            return _count; 
        } 
    } 
} 

public partial class _Default : System.Web.UI.Page 
{ 
    protected void Page_Load(object sender, EventArgs e) 
    { 
        // print the count 
        lblText.Text = string.Format("Count={0}""", StaticClass.Count); 
    } 
}
</pre>

<p>The very first time I run this code the count prints 1. If I refresh the page it prints 2. <b>If I close the browser and run the application again, what would you expect it would print?</b></p>

<p>If you guessed 1 you guessed wrong (like I did.) It will print 3.</p>

<p>Closing the browser does not get rid of the static class since apparently the App Domain still is running under IIS. If you really want to force the constructor of the static class to be fired (and in this case reset the counter to 0) you need to kill the worker process in IIS (e.g. run <code>iisreset</code>)</p>

<p>In hindsight this is obvious and, as one of my co-workers pointed out, we are lucky ASP.NET apps work like that! It would suck big time if I every time a user closed their browser the application would be closed as well and the next user will need to pay the load time.</p>

<p>The moral of the story is keep in mind that you don't have much control on <i>when</i> the static constructor will be fired in an ASP.NET application. You have the guarantee that it will be fired the very first time the class is accessed in the application domain. This includes the very first time the class is accessed after the app is loaded into IIS, but it also means that if the worker process is recycled (and your app domain goes away with it,) the static constructor will be fired (again) the next time the class is hit when a new user visits your site. This is all good and the desired effect, but just keep it in mind.</p>

    </div>

    <div class="container">
      <footer>
        <p>
          <hr>
          License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
        </p>
      </footer>
    </div>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Highlight the current menu option
      var highlightMenu = function() {
        var menuId = "home-menu";
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          menuId = "blog-menu";
        } else if(url == "/about") {
          menuId = "about-menu";
        } if(url == "/draft") {
          menuId = "draft-menu";
        }if(url == "/page") {
          menuId = "page-menu";
        }
        var el = document.getElementById(menuId);
        el.classList.add("active");
      }

      highlightMenu();
    </script>
  </body>
</html>
