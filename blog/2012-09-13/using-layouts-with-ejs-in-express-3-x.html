<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="HectorCorrea.com">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>HectorCorrea.com</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>

    <!-- Styles from https://newcss.net/ -->
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.css">

    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <link rel="canonical" href="https://hectorcorrea.com" />

    <style>
      nav {
        float:right;
      }

      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      footer {
        background: var(--nc-bg-2);
        border-bottom: 1px solid var(--nc-bg-3);
        padding: 2rem 1.5rem;

        margin: -2rem calc(0px - (50vw - 50%)) 2rem;

        padding-left: calc(50vw - 50%);
        padding-right: calc(50vw - 50%);

        margin-top: -0px;
        margin-bottom: 0px;
        padding-top: 6px;
        padding-bottom: 6px;
        color: gray;
        font-size: x-small;
      }

      .header-link {
        /* Main body text, see new.css */
        color: var(--nc-tx-2);
        text-decoration: none;
      }

      .nav-link-selected {
        font-weight: bold;
      }

      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="/">Hector Correa</a></h1>
      <nav>
        <a id="about-menu" href="/about" role="button" class="btn btn-secondary btn-sm">About</a>
        / <a id="presentations-menu" href="/presentations" role="button" class="btn btn-secondary btn-sm">Presentations</a>
        / <a id="blog-menu" href="/blog" role="button" class="btn btn-secondary btn-sm">Blog</a>
      </nav>
    </header>

    <div class="container">
      <h1>Using layouts with EJS in Express 3.x</h1>
<p>Over the last couple of months I've been meaning to update <a href="https://github.com/hectorcorrea/simple-blog">my sample Express.js application</a> from Express 2.x to Express 3.x but the fact that support for layouts was removed from Express 3.x was holding me back.</p>

<p>In Express 2.x the framework itself supported the concept of layouts and both template engines, Jade and EJS, worked nicely with it. In Express 3.x the functionality has been removed from the framework and now the template engines need to be updated to provide this support themselves.</p>

<p>This week I found that EJS has been updated to support <a href="https://github.com/visionmedia/ejs#includes">includes</a> and that allowed me to emulate in Express 3.x the concept of layouts that I was getting with Express 2.x. This is probably the mother of all hacks, but it's simple and it works for my purposes so I am documenting it for others using Express 2.x and EJS that might be holding back on upgrading to Express 3.x just because of the lack of layouts in Express 3.x.</p>


<h2>EJS layouts in Express 2.x</h2>
<p>In Express 2.x my <i>layout.ejs</i> file looked something like this:</p>

<pre class="code">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;
    &lt;link rel='stylesheet' href='/stylesheets/style.css' />
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Header&lt;/h1&gt;
    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;
    &lt;b&gt;&lt;%- body %&gt;&lt;/b&gt;
    &lt;p&gt;the footer&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

<p>an a simple <i>index.ejs</i> file would look like this:</p>

<pre class="code">
  &lt;p&gt;the content of the page&lt;/p&gt;
</pre>


<h2>EJS layouts in Express 3.x</h2>
<p>To achieve a similar behavior in Express 3.x I ended up (1) splitting my layout.ejs file in two files (layoutTop.ejs and layoutBottom.ejs) and (2) updating my views to explicitly include the top and bottom layout files. The following example shows this:</p>

<p>The contents of <i>layoutTop.ejs</i>* looks like this</p>

<pre class="code">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;
    &lt;link rel='stylesheet' href='/stylesheets/style.css' />
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Header&lt;/h1&gt;
    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;
</pre>

<p>whereas the contents of <i>layoutBottom.ejs</i> looks like this</p>

<pre class="code">
    &lt;p&gt;the footer&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

<p>and finally my <i>index.ejs</i> file now looks like this</p>

<pre class="code">
&lt;% include layoutTop %&gt;
&lt;p&gt;the content of the page&lt;/p&gt;
&lt;% include layoutBottom %&gt;
</pre>

<p>Notice how the <i>index.ejs</i> explicitly requests the two layout files which is a bit annoying since in the previous version this was implicit but I think it's a small price to pay to keep the functionality working.</p>

<h2>A few final words...</h2>
<p>Although this approach is not nearly as elegant as what Express 2.x and EJS provided, I liked it because its  simple enough that allowed me to upgrade to Express 3.x without having to switch template engines, download somebody else's fork of EJS, or invest a lot of time learning how to build a template engine to support this behavior.</p>

<p>I am sure a more elegant solution can be achieved by taking a closer look at both the EJS and Express 3.x source code but I will leave that for another day/blog post.</p>

    </div>

    <footer>
      License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
    </footer>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Hande this redirect via JavaScript because GitHub pages does not let me
      // handle this via an HTML redirect due to the ".aspx" extension
      if (window.location.pathname === "/blog/The-Mythical-Man-Month.aspx") {
        window.location = "https://hectorcorrea.com/blog/2007-06-28/the-mythical-man-month";
      }

      // Highlight the current menu option
      var highlightMenu = function() {
        var activeOption = null;
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          activeOption = document.getElementById("blog-menu");
        } else if(url == "/about") {
          activeOption = document.getElementById("about-menu");
        } else if(url == "/presentations") {
          activeOption = document.getElementById("presentations-menu");
        }

        if (activeOption != null) {
          activeOption.classList.add("nav-link-selected");
        }
      }

      highlightMenu();
    </script>
  </body>
</html>
