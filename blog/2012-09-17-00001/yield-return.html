<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="HectorCorrea.com">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>HectorCorrea.com</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <link rel="canonical" href="https://hectorcorrea.com" />
 
    <style>
      .header-container {
        background-color:  #e1ebf7;
        margin-left: 0px;
        max-width: unset;
        border-bottom-style: solid;
        border-bottom-width: 2px;
        max-height: 75px;
      }

      h1 {
        margin-top: 20px;
      }

      blockquote {
        padding: 10px 20px;
        margin: 0 0 20px;
        border-left: 5px solid #eee;
        font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;
      }

      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      /* Overwrite Bootstrap's default */
      code {
        background-color: #f0f1f2;
        color: #0D0D0D; /* gray-ish */
      }

      /* Custom code and terminal styles */
      pre, pre.code {
        margin-left: 20px;
        display: block;
        padding: 9.5px;
        margin: 0 0 10px;
        margin-left: 0px;
        font-size: 13px;
        line-height: 1.428571429;
        color: #333;
        word-break: break-all;
        word-wrap: break-word;
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      pre.terminal {
        margin-left: 20px;
        margin-bottom: 20px;
        background-color: #363446;
        color: #DAD681; /* yellow-ish */
        padding-bottom: 10px;
        padding-top: 10px;
        padding-left: 10px;
        padding-right: 50px;
      }

      .socialList {
        list-style: none;
        padding: 5px;
      }
      
      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }

      footer {
        font-weight: lighter;
      }
    </style>
  </head>
  <body>

    <div class="container header-container">
      <!-- header source: https://getbootstrap.com/docs/5.1/examples/headers/
        changes: removed border-bottom -->
      <header class="d-flex flex-wrap justify-content-center py-3 mb-4">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
          <span class="fs-4">HectorCorrea.com</span>
        </a>
        <ul class="nav nav-pills">
          <li class="nav-item"><a id="home-menu" href="/" class="nav-link" aria-current="page">Home</a></li>
          <li class="nav-item"><a id="about-menu" href="/about" class="nav-link">About</a></li>
          <li class="nav-item"><a id="blog-menu" href="/blog" class="nav-link">Blog</a></li>
        </ul>
      </header>
    </div>

    <div class="container">
      <h1>Yield Return</h1>
<p>Even though the <code>yield return</code> statement was added to C# since version 2.0 (around 2004) I never quite understood how it really works. A few days ago while going through some tutorials I saw a sample of code that used <code>yield return</code> and decided to finally look under the covers and learn how it works.</p>

<p>How well do you understand <code>yield return</code>? Look at the code below and answer these two questions:</p>

<ul>
<li>What is the output of this code?
<li>Can you explain why?
</ul>


<pre class="code">
class YieldSample
{
  static void Main(string[] args)
  {
    foreach (int i in YieldSample.GetSomeIntegers())
    {
      Console.WriteLine("{0}", i);
    }
    Console.ReadLine();
  }
  public static IEnumerable&lt;int&gt; GetSomeIntegers()
  {
    yield return 100;
    yield return 200;
    yield return 300;
  }
}
</pre>

<p>The answer to the first question is pretty simple: 100, 200, and 300.</p>

<p>The tricky part is explaining how come C# arrives to this output. How come C# knows that it needs to pick up the first value (100) in the first loop, 200 in the second, and 300 in the third one?</p>

<p>The reason for this behavior is that <b>at compile time C# rewrites the code with the <code>yield return</code> into a state machine</b> that has the logic to return the first value and prepare the code so that in the second call it picks up the second value, and so on and so forth. The pseudo-code for the generated code basically looks like this:</p>

<pre class="code">
private bool GetNextElement()
{
  switch ( state )
  {
    case 0:         // first state of the machine
      currentValue = 100;
      state = 1; // prepare machine for next state
      return true;
    case  1:       // second state of the machine
      currentValue = 200
      state = 2; // prepare machine for next state
      return true;
    case   2:     // third state of the machine
      currentValue = 300;
      state = 3; // prepare machine for next state
      return true;
    case   3: 
      state = -1
      return false;
   }
}
</pre>

<p>While trying to understand how the <code>yield return</code> statement works I found two great articles that explain this in more detail. In particularly I liked <a href="http://shadowcoding.blogspot.com/2009/01/yield-and-c-state-machine.html">Yield, and the C# state machine</a> by Erik Forbes and <a href="http://www.devsource.com/c/a/Languages/C-Dynamic-Iterators-with-Yield-Return">C#: Dynamic Iterators with Yield Return</a> by Paul Kimmel. These two articles actually gave me the clue to use Reflector to look at the code generated by the compiler.</p>

<p>If you are like me you are probably wondering how well this code generation works when the method is not as straightforward as this little example that just returns three hard coded values. The answer is pretty darn good. <a href="http://en.wikipedia.org/wiki/Finite-state_machine">State machines</a> have been studied by a lot of people and very well understood.</p>

<p>However, just for fun I wrote a few examples of my own with <code>if</code> and nested <code>if</code> statements around the <code>yield return</code> and reviewed the code that the compiler generated. The result was always the same: the resulting code returned the values as expected.</p>


    </div>

    <div class="container">
      <footer>
        <p>
          <hr>
          License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
        </p>
      </footer>
    </div>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Highlight the current menu option
      var highlightMenu = function() {
        var menuId = "home-menu";
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          menuId = "blog-menu";
        } else if(url == "/about") {
          menuId = "about-menu";
        } if(url == "/draft") {
          menuId = "draft-menu";
        }if(url == "/page") {
          menuId = "page-menu";
        }
        var el = document.getElementById(menuId);
        el.classList.add("active");
      }

      // Display the session expiration time in local time
      var displaySessionLocalTime = function() {
        var el = document.getElementById("sessionExpiresOn");
        if (el === null) {
          return;
        }
        var zTime = el.textContent.substring(0,19) + "Z";
        var date = new Date(zTime);
        el.textContent = date.toLocaleString();
      }

      highlightMenu();
      displaySessionLocalTime();
    </script>
  </body>
</html>
