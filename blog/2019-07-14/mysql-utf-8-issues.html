<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="HectorCorrea.com">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>HectorCorrea.com</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>

    <!-- Styles from https://newcss.net/ -->
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.css">

    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <link rel="canonical" href="https://hectorcorrea.com" />

    <style>
      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      footer {
        background: var(--nc-bg-2);
        border-bottom: 1px solid var(--nc-bg-3);
        padding: 2rem 1.5rem;

        margin: -2rem calc(0px - (50vw - 50%)) 2rem;

        padding-left: calc(50vw - 50%);
        padding-right: calc(50vw - 50%);

        margin-top: -0px;
        margin-bottom: 0px;
        padding-top: 6px;
        padding-bottom: 6px;
        color: gray;
        font-size: x-small;
      }

      .header-link {
        /* Main body text, see new.css */
        color: var(--nc-tx-2);
        text-decoration: none;
      }

      .nav-link-selected {
        font-weight: bold;
      }

      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="/">Hector Correa</a></h1>
      <nav style="float:right;">
        <a id="about-menu" href="/about" role="button" class="btn btn-secondary btn-sm">About</a>
        / <a id="presentations-menu" href="/presentations" role="button" class="btn btn-secondary btn-sm">Presentations</a>
        / <a id="blog-menu" href="/blog" role="button" class="btn btn-secondary btn-sm">Blog</a>
      </nav>
    </header>

    <div class="container">
      <h1>MySQL UTF-8 issues</h1>
<p>A few months ago I upgraded the machine where this website runs from a machine with Ubuntu 14 to one running Ubuntu 19. Because I was coming from a very old version of Ubuntu I decided to create a brand new virtual machine with Ubuntu 19 and move the content myself rather than letting Ubuntu attempt to migrate my stuff.</p>

<p>This was a good idea because a lot has changed from Ubuntu 14 to Ubuntu 19, plus it gave me the chance to start from a clean slate. However, in doing the migration manually I missed the step to configure the MySQL database to use UTF-8 and I left it instead with the default of Latin 1.</p>

<p>This resulted in a few of the blogs displaying a bunch strange characters for things that are not part of the Latin 1 character set, for example several of the blogs where showing <code>Â</code> or <code>â€™</code> and you'll see  <code>Iâ€™ve</code> instead of  <code>I've</code>.</p>

<p>When I saw this I knew right away that the problem was character encoding in the database, but I wasn't sure how to fix the data. Turns out there were two steps that I had to take.</p>

<h2>Step 1 - configure the database</h2>

<p>The first step was to configure the database to use UTF-8 character set. This was pretty straight forward. From the MySQL prompt I issued the following command to see what the current character set was, notice that it reported <code>latin1</code>:</p>

<pre>
mysql&gt; SELECT @@character_set_database, @@collation_database;
+--------------------------+----------------------+
| @@character_set_database | @@collation_database |
+--------------------------+----------------------+
| latin1                   | latin1_swedish_ci    |
+--------------------------+----------------------+
</pre>

<p>Then I changed the character set to <code>utf8</code> via the <code>ALTER DATABASE</code> command:</p>

<pre>
mysql&gt; ALTER DATABASE blogdb CHARACTER SET utf8 COLLATE utf8_general_ci;
Query OK, 1 row affected (0.00 sec)

mysql&gt; SELECT @@character_set_database, @@collation_database;
+--------------------------+----------------------+
| @@character_set_database | @@collation_database |
+--------------------------+----------------------+
| utf8                     | utf8_general_ci      |
+--------------------------+----------------------+
</pre>

<h2>Step 2 - update the data</h2>

<p>Setting the character set as I did above makes sure that the database uses UTF-8 as I save new data into it, but it did not update the records already stored on it. I found <a href="https://stackoverflow.com/a/9305294/446681">this answer</a> in StackOverflow that shows how to convert the existing data from one character set to another.</p>

<p>In my case I ran a SQL script that converted the <code>contentMd</code> field to <code>binary</code> and then to <code>utf8</code> and that took care of the issue:</p>

<pre>
mysql&gt; update blogs set contentMd = convert(convert(contentMd using binary) using utf8);
</pre>

<h2>Final words</h2>
<p>Of course, I backed up the database before and after I did these steps, just in case, but so far, it looks like the data now is handled correctly.</p>

<p>I also updated my server notes to remind me to configure the character set if I ever setup a brand new Ubuntu box. You can see my Ubuntu Server configuration notes on this <a href="https://github.com/hectorcorrea/ubuntuserver">GitHub repo</a>.</p>

    </div>

    <footer>
      License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
    </footer>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Hande this redirect via JavaScript because GitHub pages does not let me
      // handle this via an HTML redirect due to the ".aspx" extension
      if (window.location.pathname === "/blog/The-Mythical-Man-Month.aspx") {
        window.location = "https://hectorcorrea.com/blog/2007-06-28/the-mythical-man-month";
      }

      // Highlight the current menu option
      var highlightMenu = function() {
        var activeOption = null;
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          activeOption = document.getElementById("blog-menu");
        } else if(url == "/about") {
          activeOption = document.getElementById("about-menu");
        } else if(url == "/presentations") {
          activeOption = document.getElementById("presentations-menu");
        }

        if (activeOption != null) {
          activeOption.classList.add("nav-link-selected");
        }
      }

      highlightMenu();
    </script>
  </body>
</html>
