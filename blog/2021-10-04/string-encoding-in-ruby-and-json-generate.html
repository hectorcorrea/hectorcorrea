<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="HectorCorrea.com">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>HectorCorrea.com</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>

    <!-- Styles from https://newcss.net/ -->
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.css">

    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <link rel="canonical" href="https://hectorcorrea.com" />

    <style>
      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      footer {
        background: var(--nc-bg-2);
        border-bottom: 1px solid var(--nc-bg-3);
        padding: 2rem 1.5rem;

        margin: -2rem calc(0px - (50vw - 50%)) 2rem;

        padding-left: calc(50vw - 50%);
        padding-right: calc(50vw - 50%);

        margin-top: -0px;
        margin-bottom: 0px;
        padding-top: 6px;
        padding-bottom: 6px;
        color: gray;
        font-size: x-small;
      }

      .header-link {
        /* Main body text, see new.css */
        color: var(--nc-tx-2);
        text-decoration: none;
      }

      .nav-link-selected {
        font-weight: bold;
      }

      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="/">Hector Correa</a></h1>
      <nav style="float:right;">
        <a id="about-menu" href="/about" role="button" class="btn btn-secondary btn-sm">About</a>
        / <a id="presentations-menu" href="/presentations" role="button" class="btn btn-secondary btn-sm">Presentations</a>
        / <a id="blog-menu" href="/blog" role="button" class="btn btn-secondary btn-sm">Blog</a>
      </nav>
    </header>

    <div class="container">
      <h1>String encoding in Ruby and JSON.generate()</h1>
<p>Last week at work we ran into an interesting string encoding issue. The gist of the problem is that we had a string that was valid in Ruby but Ruby threw an exception when we used it in a call to <code>JSON.generate()</code>. Below is a simplified version of this scenario:</p>

<pre>
&gt;&gt; text = "\x81ru"
=&gt; "\x81ru"

&gt;&gt; hash = { "language" =&gt; text }
=&gt; {"language"=&gt;"\x81ru"}

&gt;&gt; JSON.generate(hash)
=&gt; [...] JSON::GeneratorError (source sequence is illegal/malformed utf-8)

&gt;&gt; puts text
?ru
=&gt; nil
</pre>

<p>Notice how Ruby accepts the string and that I am able to use it in a hash, but then <code>JSON.generate()</code> throws an exception when it tries to use it.</p>

<p>If I print the string to the console with <code>puts text</code> the output is <code>?ru</code> which is already suspicious, notice the "?" at the beginning. Something is amiss with this string but what is it? And why can I pass it around but then <code>JSON.generate()</code> throws an error?</p>

<h2>Digging into the issue</h2>
<p>The exception reported makes it clear that this is an encoding issue, the text itself says "malformed utf-8". In looking for information about string encoding in Ruby I ran into the post <a href="https://tenderlovemaking.com/2020/01/13/guide-to-string-encoding-in-ruby.html">Guide to String Encoding in Ruby</a> by Aaron Patterson that helped me get a better understanding of the problem.</p>

<p>One of the things that Patterson makes clear is that the <i>encoding</i> of a string is a separate property of the string. The string itself is an array of bytes and the encoding is a separate object that is related to the string. This is why it's possible to have strings (i.e. sequence of bytes) assigned to the wrong encoding.</p>

<p>Ruby provides some helpful methods to dig further into a string and its encoding. The method <code>valid_encoding?</code> for example checks the string against its current encoding and reports whether it's valid or not. Below is an example of how our problematic string is reported:</p>

<pre>
&gt;&gt; text = "\x81ru"
=&gt; "\x81ru"

&gt;&gt; text.encoding
=&gt; #&lt;Encoding:UTF-8&gt;

&gt;&gt; text.valid_encoding?
=&gt; false
</pre>

<p>As we can see the string is assigned UTF-8 encoding by default but this particular string is <b>not</b> valid UTF-8.</p>

<p>The fact that the bytes and the encoding are separate explains why we can have a string with an incorrect encoding and why we were able to pass it around and use it (like inside a hash). The post by Patterson provides more information on why this is a good design and reviews other methods that we can use to handle encodings in Ruby strings.</p>

<h2>JSON.generate() error</h2>
<p>So now we know why we were able to store our problematic string and pass it around. The last piece of the puzzle is to find out why does <code>JSON.generate()</code> throw an exception when it tries to use it. My guess is that <code>JSON.generate()</code> is somehow making sure the string is valid for the UTF-8 encoding and since it isn't it throws an exception.</p>

<p>I can force Ruby to throw a similar (but not identical) exception with the following code:</p>

<pre>
&gt;&gt; text = "\x81ru"
=&gt; "\x81ru"

&gt;&gt; text.encode("ASCII", "UTF-8")
[...] Encoding::InvalidByteSequenceError ("\x81" on UTF-8)
</pre>

<p>I found the text of the original exception "source sequence is illegal/malformed utf-8" inside the Ruby source code. It seems to me that the code for <code>JSON.generate()</code> relies on <a href="https://github.com/ruby/ruby/blob/d92f09a5eea009fa28cd046e9d0eb698e3d94c5c/ext/json/generator/generator.c#L140-L143">this C code</a> to make sure the string is valid UTF-8 before using it, but I am not familiar with the Ruby source code so take this with a grain of salt.</p>

    </div>

    <footer>
      License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
    </footer>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Hande this redirect via JavaScript because GitHub pages does not let me
      // handle this via an HTML redirect due to the ".aspx" extension
      if (window.location.pathname === "/blog/The-Mythical-Man-Month.aspx") {
        window.location = "https://hectorcorrea.com/blog/2007-06-28/the-mythical-man-month";
      }

      // Highlight the current menu option
      var highlightMenu = function() {
        var activeOption = null;
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          activeOption = document.getElementById("blog-menu");
        } else if(url == "/about") {
          activeOption = document.getElementById("about-menu");
        } else if(url == "/presentations") {
          activeOption = document.getElementById("presentations-menu");
        }

        if (activeOption != null) {
          activeOption.classList.add("nav-link-selected");
        }
      }

      highlightMenu();
    </script>
  </body>
</html>
